# 项目修复计划（完整）

## 1. 目标与范围
- 目标：将项目修复到“可稳定重复执行、结果不覆盖不污染、可观测可排障”的可用状态。
- 范围：主流程、Step2/3/4、配置校验、统计上报、基础测试、文档同步。

## 2. 优先级与里程碑
### P0（必须先完成）
- 修复向量写入覆盖风险与重复入库问题。
- 修复 Step2/Step3 状态机回退和重跑幂等问题。
- 修复默认输入路径与启动前配置检查，避免运行中途失败。

### P1（稳定性与可维护性）
- 修复主报告统计失真（LLM/Embedding 调用统计）。
- 强化场景切分校验链路（顺序/重叠告警）。
- 增加无外部 API 依赖的回归测试。

### P2（收口）
- 文档更新（运行方式、重跑语义、故障排查）。

## 3. 详细工作项
1. 向量化写入（Step4）
- 改为稳定点 ID（基于 `chapter_id + scene_index`）而非“估算下一个 ID”。
- 章节重跑前，按 `chapter` 过滤删除旧点，再执行 upsert。
- 保留跨章节数据，避免误删。

2. 状态机与幂等（Step2/Step3/Step4）
- 明确状态流：`pending -> scenes_done -> annotated_done -> vectorized`。
- Step2 默认跳过已到下游状态章节（`annotated_done/vectorized`）。
- Step3 默认跳过 `vectorized`，仅在强制/重做时回算。
- 重做章节时清理下游字段（如 `annotated_file`）以避免脏状态。
- Step4 在 `--force` 下允许重算已 `vectorized` 章节。

3. 报告统计与可观测性（main + utils clients）
- 引入跨实例全局统计累加，避免报告阶段“新建客户端导致统计为 0”。
- 主报告读取全局统计，展示真实调用数据。

4. 配置与启动校验（main）
- 启动前校验配置结构、API Key 占位符、路径和输入文件。
- 无 `--input` 且配置输入不存在时，自动尝试样例文件并打印提示。
- 错误尽早失败并附修复建议。

5. 场景校验增强（Step2）
- 在提取后增加顺序与重叠检查告警，便于定位切分质量问题。
- 覆盖率补片后保留告警上下文。

6. 测试补齐（tests）
- 覆盖稳定点 ID 生成。
- 覆盖章节过滤删除条件。
- 覆盖配置校验（占位 key、缺失输入文件）。
- 覆盖关键状态判断辅助函数。

7. 文档更新
- 同步 README / QUICKSTART 的运行命令与排障说明。
- 明确 `python3` 命令、重跑语义、常见错误。

## 4. 验收标准
- 可以多次执行同一章节向量化，点数不异常增长，章节内数据可更新。
- 不带 `--force` 的重复运行不会把 `vectorized` 回退到上游状态。
- 启动前能拦截配置/输入错误，报错清晰。
- 报告显示非零且与实际运行一致的调用统计。
- 本地静态检查（`python3 -m py_compile`）通过，测试可执行。

## 5. 执行顺序
1. 完成 P0（Step4 + 状态机 + 配置校验）
2. 完成 P1（统计 + 场景校验 + 测试）
3. 完成 P2（文档）
4. 执行验证并输出变更总结
